# This code is licensed from CircleCI to the user under the MIT license. See
# https://circleci.com/orbs/registry/licensing for details.
version: 2.1

description: |
  Use the Harbormaster Orb ti generate fully functioning and deployable 
  projects from a single "project-as-code" YAML file. The result is an MVP quality application based on a 
  single business model using one of the many supported technology stacks.
  
  Growing list of tech stacks include:
  Apollo, Angular7, Django, Go, Ruby on Rails, Spring Boot, AWS Lambda, 
  Google Functions, ASP.NET, Spark Microweb and Struts2.
  
  Support Model Formats:
  YAML, JSON, UML, XMI, Eclipse Model Framework, Java source code in a GIT repo, and SQL Scripts.  
  
  More details and example files can be found at:
  https://github.com/Harbormaster-AI/circle.ci.orb
  
  Use the following config.yml as an example to use the Harbormaster Orb:
  https://github.com/Harbormaster-AI/circle.ci.orb/blob/main/.circleci/config.yml
  
  The source for the Harbormaster Orb is available at:
  https://github.com/Harbormaster-AI/circle.ci.orb/harbormaster_orb.yaml
   
 
commands:

  initialize:
  
    description: |
      Command to initialize the Harbormaster orb by providing your
      API token. This token is obtained from your online account 
      under User Preferences access on http://platform.harbormaster.com. 
      
    parameters:
      api-token:
        description: "Your Harbormaster API token"
        type: env_var_name
      
    steps:
      ##--------------------------------------------------------------------
      ## checkout the relevant files to a directory referenced by
      ## ${CIRCLE_PROJECT_REPONAME}
      ##--------------------------------------------------------------------
      - checkout:
          path: "~/${CIRCLE_PROJECT_REPONAME}"

      ##--------------------------------------------------------------------
      ## print the environment variables to ensure things look well
      ##--------------------------------------------------------------------
      - run:
          name: print environmental variables
          command: printenv
          
      ##--------------------------------------------------------------------
      ## make sure the latest version of npm is in use
      ##--------------------------------------------------------------------
      - run:                                                    
          name: update npm
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO npm install -g npm@latest' 

      ##--------------------------------------------------------------------
      ## install the latest version of npm-run
      ##--------------------------------------------------------------------
      - run:                                                    
          name: install npm-run
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO npm install -g npm-run@latest'    
          
      ##--------------------------------------------------------------------
      ## install the Harbormaster CLI
      ##--------------------------------------------------------------------
      - run:                                 
          name: install Harbormaster command line interface (CLI)
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO npm install -g harbormaster-ai'
          
      ##--------------------------------------------------------------------
      ## initialize the user with Harbormaster
      ##--------------------------------------------------------------------
      - run:
          name: initialize user for Harbormaster
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO npm-run harbormaster init << parameters.api-token >>'

      ##--------------------------------------------------------------------
      ## update apt-get
      ##--------------------------------------------------------------------
      - run: 
          name: update the apt-get package index
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO apt-get update'

      ##--------------------------------------------------------------------
      ## install dos2unix to make sure files are formatted correctly
      ##--------------------------------------------------------------------
      - run: 
          name: install dos2unix to convert uploaded files
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO apt-get install -y dos2unix'

  generate_devops_project:  
    description: |
      Command to generate a DevOps project by providing a Project-as-Code YAML file
    parameters:
      project-as-code-yaml-file:
        description: "Project-as-Code YAML file containing the project generation directives"
        type: string
        default: "${PROJECT_AS_CODE_YAML_FILE}"
        
    steps:
      ##--------------------------------------------------------------------
      ## call the Harbormaster CLI to generate the project
      ##--------------------------------------------------------------------
      - run:
          name: Generating project
          command: '[ $EUID == 0 ] && SUDO="" || SUDO=sudo && $SUDO harbormaster project_generate ~/${CIRCLE_PROJECT_REPONAME}/<< parameters.project-as-code-yaml-file >>'


  